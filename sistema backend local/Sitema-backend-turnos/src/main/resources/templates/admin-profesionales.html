<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<th:block th:fragment="contenido">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>GestiÃ³n de Profesionales</h1>
        <div class="btn-group">
            <a href="/admin/profesionales/nuevo" class="btn btn-success">âž• Nuevo Profesional</a>
            <a href="/admin/usuarios/nuevo" class="btn btn-primary">ðŸ”‘ Crear Usuario</a>
        </div>
    </div>

    <div class="mb-3">
        <input type="text" id="buscadorTabla" class="form-control"
               placeholder="ðŸ” Buscar por nombre, especialidad o usuario..."
               onkeyup="filtrarTabla()">
    </div>

    <div class="table-container shadow-sm">
        <table class="table align-middle">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Nombre y Apellido</th>
                <th>Especialidad</th>
                <th>Estado</th>
                <th>Acceso al Sistema</th>
                <th class="text-end">Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${profesionales}">
                <td th:text="${p.id}"></td>
                <td><div class="fw-bold" th:text="${p.nombre}"></div></td>
                <td><span class="badge bg-light text-dark border" th:text="${p.especialidad}"></span></td>
                <td>
                    <span th:if="${p.activo}" class="badge bg-success">Activo</span>
                    <span th:unless="${p.activo}" class="badge bg-secondary">Inactivo</span>
                </td>

                <td>
                    <div th:if="${p.tieneUsuario}">
                        <span class="badge bg-info-subtle text-info border border-info">
                            <i class="bi bi-person-check-fill"></i> Con Usuario
                        </span>
                    </div>
                    <div th:unless="${p.tieneUsuario}">
                        <a th:href="@{/admin/usuarios/nuevo(profesionalId=${p.id})}"
                           class="btn btn-outline-primary btn-sm py-0"
                           style="font-size: 0.75rem;">
                            âž• Asignar Usuario
                        </a>
                    </div>
                </td>

                <td class="text-end">
                    <div class="btn-group">
                        <a th:href="@{/admin/profesionales/editar/{id}(id=${p.id})}"
                           class="btn btn-editar btn-sm">Editar</a>

                        <button th:if="${p.activo}" type="button" class="btn btn-cancelar btn-sm"
                                th:onclick="'confirmarEstadoProf(' + ${p.id} + ', false)'">
                            Baja
                        </button>

                        <button th:unless="${p.activo}" type="button" class="btn btn-success btn-sm"
                                th:onclick="'confirmarEstadoProf(' + ${p.id} + ', true)'">
                            Reactivar
                        </button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <a href="/admin/dashboard" class="btn btn-secondary">
            â¬… Volver al Panel Principal
        </a>
    </div>

    <script th:inline="javascript">
        /* 1. ALERTAS DE Ã‰XITO O ERROR AL CARGAR LA PÃGINA */
        const successMsg = [[${success}]];
        const errorMsg = [[${error}]];

        if (successMsg) {
            Swal.fire({
                icon: 'success',
                title: 'Â¡Excelente!',
                text: successMsg,
                timer: 2500,
                showConfirmButton: false
            });
        }

        if (errorMsg) {
            Swal.fire({
                icon: 'error',
                title: 'AtenciÃ³n',
                text: errorMsg
            });
        }

        /* 2. CONFIRMACIÃ“N PARA CAMBIO DE ESTADO */
        function confirmarEstadoProf(id, activar) {
            const titulo = activar ? 'Â¿Reactivar profesional?' : 'Â¿Desactivar profesional?';
            const texto = activar ? 'VolverÃ¡ a estar disponible para turnos.' : 'Ya no aparecerÃ¡ disponible para nuevos turnos.';
            const url = activar ? '/admin/profesionales/activar/' + id : '/admin/profesionales/desactivar/' + id;

            Swal.fire({
                title: titulo,
                text: texto,
                icon: activar ? 'question' : 'warning',
                showCancelButton: true,
                confirmButtonColor: activar ? '#198754' : '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: activar ? 'SÃ­, reactivar' : 'SÃ­, desactivar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = url;
                    document.body.appendChild(form);
                    form.submit();
                }
            })
        }

        /* 3. FILTRADO DINÃMICO */
        function filtrarTabla() {
            let input = document.getElementById("buscadorTabla");
            let filter = input.value.toLowerCase();
            let tr = document.querySelectorAll("tbody tr");

            tr.forEach(row => {
                let text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        }
    </script>

</th:block>
</html>