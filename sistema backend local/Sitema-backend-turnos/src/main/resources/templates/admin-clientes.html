<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: html">

<th:block th:fragment="contenido">

    <h1 class="mb-4">Clientes</h1>

    <a th:href="@{/admin/clientes/nuevo(from='clientes')}"
       class="btn btn-success mb-3">âž• Crear cliente</a>
    <div class="mb-3">
        <input type="text" id="buscadorTabla" class="form-control"
               placeholder="ðŸ” Buscar por nombre, documento o especialidad..."
               onkeyup="filtrarTabla()">
    </div>
    <div class="table-container">
        <table class="table align-middle">
            <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Documento</th>
                <th>Email</th>
                <th>TelÃ©fono</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="c : ${clientes}">
                <td th:text="${c.nombre}"></td>
                <td th:text="${c.apellido}"></td>
                <td th:text="${c.documento}"></td>
                <td th:text="${c.email}"></td>
                <td th:text="${c.telefono}"></td>
                <td>
                    <span th:if="${c.activo}" class="badge bg-success">Activo</span>
                    <span th:unless="${c.activo}" class="badge bg-secondary">Inactivo</span>
                </td>
                <td>
                    <div class="btn-group">
                        <a th:href="@{/admin/clientes/editar/{id}(id=${c.id})}" class="btn btn-sm btn-editar">Editar</a>

                        <button th:if="${c.activo}" type="button" class="btn btn-sm btn-cancelar"
                                th:onclick="'confirmarDesactivarCliente(' + ${c.id} + ')'">
                            Baja
                        </button>

                        <button th:unless="${c.activo}" type="button" class="btn btn-sm btn-success"
                                th:onclick="'confirmarActivarCliente(' + ${c.id} + ')'">
                            Reactivar
                        </button>

                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>



    <!-- Controles de paginaciÃ³n -->
    <div class="mt-3 d-flex justify-content-between align-items-center">
        <a th:if="${clientesPage.hasPrevious()}"
           th:href="@{/admin/clientes(page=${clientesPage.number - 1}, size=${clientesPage.size})}"
           class="btn btn-secondary btn-sm">â¬… Anterior</a>

        <span>PÃ¡gina <span th:text="${clientesPage.number + 1}"></span> de
              <span th:text="${clientesPage.totalPages}"></span></span>

        <a th:if="${clientesPage.hasNext()}"
           th:href="@{/admin/clientes(page=${clientesPage.number + 1}, size=${clientesPage.size})}"
           class="btn btn-secondary btn-sm">Siguiente âž¡</a>
    </div>

    <a href="/admin/dashboard" class="btn btn-secondary mt-3">â¬… Volver</a>

    <script>
        function enviarPost(url) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = url;
            document.body.appendChild(form);
            form.submit();
        }

        function confirmarDesactivarCliente(id) {
            Swal.fire({
                title: 'Â¿Desactivar cliente?',
                text: "No podrÃ¡ sacar nuevos turnos.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'SÃ­, desactivar'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarPost('/admin/clientes/desactivar/' + id);
                }
            })
        }

        function confirmarActivarCliente(id) {
            Swal.fire({
                title: 'Â¿Reactivar cliente?',
                text: "El cliente volverÃ¡ a estar activo.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'SÃ­, reactivar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // CORREGIDO: Ahora apunta a /activar/
                    enviarPost('/admin/clientes/activar/' + id);
                }
            });
        }

        function filtrarTabla() {
    let input = document.getElementById("buscadorTabla");
    let filter = input.value.toLowerCase();
    let table = document.querySelector("table");
    let tr = table.getElementsByTagName("tr");

    // Empezamos desde 1 para saltar el encabezado (thead)
    for (let i = 1; i < tr.length; i++) {
        let visible = false;
        let td = tr[i].getElementsByTagName("td");

        // Recorre cada celda de la fila para ver si coincide con la bÃºsqueda
        for (let j = 0; j < td.length; j++) {
            if (td[j] && td[j].innerText.toLowerCase().indexOf(filter) > -1) {
                visible = true;
                break;
            }
        }
        tr[i].style.display = visible ? "" : "none";
    }
}
    </script>

</th:block>
</html>