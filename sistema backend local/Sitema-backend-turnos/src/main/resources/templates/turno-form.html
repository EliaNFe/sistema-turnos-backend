<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout :: html">

<th:block th:fragment="contenido">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }

        .form-container {
            background: #ffffff;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            max-width: 700px;
            margin: auto;
        }

        .header-section {
            border-left: 6px solid #10b981;
            padding-left: 1rem;
            margin-bottom: 2rem;
        }

        .form-label { font-weight: 600; color: #475569; }

        .custom-input {
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            padding: 0.7rem;
            transition: all 0.3s;
        }
        .custom-input:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn-create {
            background-color: #10b981;
            color: white;
            border-radius: 12px;
            padding: 10px 25px;
            font-weight: 600;
            border: none;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        .btn-create:hover {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
            color: white;
        }

        .btn-back {
            background-color: #f1f5f9;
            color: #475569;
            border-radius: 12px;
            padding: 10px 25px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }
        .btn-back:hover { background-color: #e2e8f0; }
    </style>

    <div class="container py-5">
        <div class="form-container">
            <div class="header-section">
                <h2 class="fw-bold mb-0" style="color: #1e293b;">Crear Nuevo Turno</h2>
                <p class="text-muted mb-0">Asigná una cita completando los campos.</p>
            </div>

            <form th:action="@{/admin/turnos/nuevo}" th:object="${turno}" method="post" id="formCrearTurno">

                <div class="mb-3">
                    <label class="form-label">Cliente:</label>
                    <input type="text" list="listaClientes" id="clienteInput" class="form-control custom-input" placeholder="Buscar por ID o Nombre..." autocomplete="off"/>
                    <input type="hidden" th:field="*{clienteId}" id="clienteIdReal"/>

                    <datalist id="listaClientes">
                        <option th:each="c : ${clientes}"
                                th:value="${c.id}"
                                th:text="${c.nombre} + ' ' + ${c.apellido}"></option>
                    </datalist>
                    <div class="mt-1">
                        <a th:href="@{/admin/clientes/nuevo(from='turnos')}" class="text-decoration-none small fw-bold text-primary">
                            <i class="bi bi-plus-circle me-1"></i>¿Es un cliente nuevo?
                        </a>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Profesional Responsable:</label>
                    <input type="text" list="listaProfesionales" id="profesionalInput" class="form-control custom-input" placeholder="Seleccionar profesional..." autocomplete="off"/>
                    <input type="hidden" th:field="*{profesionalId}" id="profesionalIdReal"/>

                    <datalist id="listaProfesionales">
                        <option th:each="p : ${profesionales}"
                                th:value="${p.id}"
                                th:text="${p.nombre}"></option>
                    </datalist>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Fecha del Turno:</label>
                        <input type="date" th:field="*{fecha}" id="fechaTurno" class="form-control custom-input"
                               min="2024-01-01" max="2035-12-31" required/>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Horario:</label>
                        <input type="time" th:field="*{hora}" class="form-control custom-input" required/>
                    </div>
                </div>

                <div class="d-flex gap-3 pt-3 border-top">
                    <button type="button" class="btn-create" onclick="validarYEnviar()">
                        <i class="bi bi-calendar-check me-2"></i>Agendar Turno
                    </button>
                    <a href="/admin/dashboard" class="btn-back">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Sincronización de IDs
        document.getElementById('clienteInput').addEventListener('input', function(e) {
            document.getElementById('clienteIdReal').value = e.target.value;
        });
        document.getElementById('profesionalInput').addEventListener('input', function(e) {
            document.getElementById('profesionalIdReal').value = e.target.value;
        });

        // Función de validación mejorada
        function validarYEnviar() {
            const fechaInput = document.getElementById('fechaTurno');

            if (!fechaInput.value) {
                alert("Por favor, seleccioná una fecha.");
                return;
            }

            const fechaSeleccionada = new Date(fechaInput.value);
            const anio = fechaSeleccionada.getFullYear();

            // Bloqueo manual para años locos (3333, 9999, etc.)
            if (anio < 2024 || anio > 2035) {
                alert("Año no permitido. Por favor ingresá un año entre 2024 y 2035.");
                fechaInput.focus();
                return;
            }

            // Si pasa la validación, llama a tu función de confirmación dulce de layout
            confirmarGuardado('formCrearTurno', '¿Confirmás la creación de este turno?');
        }
    </script>
</th:block>
</html>